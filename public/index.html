<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz</title>
    <style>
      :root {
        --bg:#0a0b0f; --ink:#eaeef6; --muted:#9aa3b2; --accent:#b76a5b;
        --glass: rgba(255,255,255,0.06); --stroke: rgba(255,255,255,0.10);
        --shadow: 0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
      }
      html,body { height:100%; }
      body {
        font-family: system-ui, -apple-system, sans-serif; margin: 0;
        background: radial-gradient(1200px 800px at 20% 10%, #11131a 0%, #0a0b0f 60%);
        color: var(--ink);
      }
      .container { max-width: 820px; margin: 0 auto; padding: 28px 20px; }
      .title { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 8px 0; min-height: 44px; }
      .brand { display:flex; align-items:center; gap:10px; min-width:0; }
      .logo { height: 28px; display:block; }
      .title h1 { display:none; }
      .title .action { color: #0a0b0f; text-decoration: none; font-weight:800; padding: 6px 10px; border-radius:999px; border:1px solid var(--accent); background: linear-gradient(180deg, color-mix(in oklab, var(--accent), white 8%), var(--accent)); line-height: 1; display:inline-flex; align-items:center; height: 28px; box-shadow: 0 4px 14px rgba(183,106,91,.28); font-size: 14px; }
      .pageTitle { text-align:left; margin: 8px 0 12px 2px; color: var(--ink); letter-spacing:.2px; font-weight:800; font-size: clamp(20px, 5.2vw, 30px); }
      .card { border:1px solid var(--stroke); border-radius: 16px; padding: 20px 18px; background: var(--glass); box-shadow: var(--shadow); backdrop-filter: blur(12px) saturate(140%); }
      .question { font-size: 22px; font-weight: 800; color: var(--ink); letter-spacing:.2px; }
      .options { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px; }
      .option { display:flex; align-items:center; gap:10px; border:1px solid var(--stroke); border-radius:12px; padding:12px 14px; cursor:pointer; background: rgba(255,255,255,0.03); color: var(--ink); transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease; box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
      .option:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.05); }
      .option input { margin-right: 2px; accent-color: var(--accent); }
      .option input:checked + span { color: var(--accent); font-weight: 800; }
      .nav { display: flex; gap: 10px; margin-top: 20px; }
      .btn { padding: 12px 16px; border-radius: 12px; border:1px solid var(--accent); background: linear-gradient(180deg, color-mix(in oklab, var(--accent), white 8%), var(--accent)); color: #0a0b0f; cursor: pointer; font-weight: 800; letter-spacing:.2px; box-shadow: 0 8px 26px rgba(183,106,91,.35); transition: transform .15s ease, box-shadow .2s ease, opacity .15s ease; }
      .btn:hover { transform: translateY(-1px); box-shadow: 0 16px 44px rgba(183,106,91,.45); }
      .btn[disabled] { opacity: .5; cursor: not-allowed; transform:none; box-shadow: var(--shadow); }
      .hidden { display: none; }
      .progress { margin: 12px 0; color: var(--muted); font-weight: 600; }
      a { color: var(--accent); }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title">
        <div class="brand">
          <img src="/assets/logo-white.png" alt="Alef" class="logo" />
        </div>
      </div>
      <h1 class="pageTitle">Alef Quiz</h1>
      <p class="progress" id="progress"></p>
      <div class="card">
        <div id="quiz"></div>
        <div class="nav" style="justify-content:flex-end;">
          <button id="nextBtn" class="btn">Next</button>
          <button id="submitBtn" class="btn hidden">Submit</button>
        </div>
      </div>
      
      <p id="status" style="margin-top:8px;"></p>
      <p style="margin-top:16px; color: var(--muted); text-align:center;">Please stay on this tab for the next question.</p>
    </div>
    <script>
      const state = { questions: [], current: 0, selections: new Map(), status: 'idle' };
      const deviceId = (() => {
        const k = 'quiz:deviceId';
        let v = localStorage.getItem(k);
        if (!v) { v = Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k, v); }
        return v;
      })();

      // Optional per-device reset: visit /?reset=1 to clear local vote locks
      (function maybeResetDeviceLocks() {
        const params = new URLSearchParams(location.search);
        if (params.get('reset') === '1') {
          const toRemove = [];
          for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k && k.startsWith('voted:q:')) toRemove.push(k);
          }
          toRemove.forEach(k => localStorage.removeItem(k));
          // Remove the reset param without reloading network if possible
          try {
            const url = new URL(location.href);
            url.searchParams.delete('reset');
            history.replaceState({}, '', url.toString());
          } catch (_) {}
        }
      })();

      async function loadQuestions() {
        const [qres, sres] = await Promise.all([
          fetch('/api/questions'),
          fetch('/api/state')
        ]);
        const qdata = await qres.json();
        const sdata = await sres.json();
        state.questions = qdata.questions;
        state.current = sdata.activeIndex || 0;
        state.status = sdata.status || 'idle';
        render();
      }

      function render() {
        const q = state.questions[state.current];
        const quiz = document.getElementById('quiz');
        const progress = document.getElementById('progress');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        progress.textContent = `Question ${state.current + 1} of ${state.questions.length}`;

        if (!q) return;
        const selected = state.selections.get(q.id);
        const alreadyVoted = localStorage.getItem(`voted:q:${q.id}`) === '1';
        quiz.innerHTML = `
          <div>
            <div class="question">${q.text}</div>
            <div class="options">
              ${q.options.map(o => `
                <label class="option">
                  <input type="radio" name="option" value="${o.id}" ${selected === o.id ? 'checked' : ''} ${alreadyVoted ? 'disabled' : ''} />
                  <span>${o.text}</span>
                </label>
              `).join('')}
            </div>
            ${alreadyVoted ? `<div style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
              <div style="color:var(--muted);font-weight:700;">Response recorded</div>
              <button id="resetVote" class="btn" style="padding:8px 12px;">Reset my selection</button>
            </div>` : ''}
          </div>
        `;

        quiz.querySelectorAll('input[name="option"]').forEach(input => {
          input.addEventListener('change', (e) => {
            state.selections.set(q.id, Number(e.target.value));
            updateButtons();
          });
        });

        updateButtons();

        const resetBtn = document.getElementById('resetVote');
        if (resetBtn) {
          resetBtn.addEventListener('click', async () => {
            try {
              await fetch('/api/vote/reset', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ questionId: q.id, deviceId })
              });
            } catch (_) {}
            localStorage.removeItem(`voted:q:${q.id}`);
            state.selections.delete(q.id);
            render();
          });
        }

        async function updateButtons() {
          const hasSelection = state.selections.has(q.id);
          // In host-driven mode we hide next/submit; keep for fallback
          const last = state.current === state.questions.length - 1;
          nextBtn.classList.toggle('hidden', true);
          submitBtn.classList.toggle('hidden', true);
          nextBtn.disabled = !hasSelection;
          submitBtn.disabled = !hasSelection;
        }
      }

      document.getElementById('nextBtn').addEventListener('click', () => {
        if (state.current < state.questions.length - 1) { state.current += 1; render(); }
      });
      document.getElementById('submitBtn').addEventListener('click', async () => {
        // legacy fallback
        const answers = state.questions.map(q => ({
          questionId: q.id,
          optionId: state.selections.get(q.id)
        }));
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers })
        });
        const data = await res.json();
        if (data.ok) window.location.href = '/thankyou.html';
      });

      // Auto-submit single vote upon selection for current active question (locks after first)
      document.addEventListener('change', async (e) => {
        if (e.target && e.target.name === 'option') {
          const q = state.questions[state.current];
          if (!q) return;
          const key = `voted:q:${q.id}`;
          if (localStorage.getItem(key) === '1') {
            // already voted for this question on this device; ignore further changes
            e.target.checked = false;
            return;
          }
          const optionId = Number(e.target.value);
          state.selections.set(q.id, optionId);
          const devBypass = new URLSearchParams(location.search).get('dev') === '1';
          // lock while submitting
          const inputs = document.querySelectorAll('input[name="option"]');
          inputs.forEach(inp => inp.disabled = true);
          try {
            const res = await fetch('/api/vote', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ questionId: q.id, optionId, deviceId })
            });
            if (res.status === 409) {
              localStorage.setItem(key, '1');
            } else if (res.ok && !devBypass) {
              localStorage.setItem(key, '1');
            } else {
              // allow re-try in dev mode or on failure
              inputs.forEach(inp => inp.disabled = false);
            }
          } catch (_) {
            inputs.forEach(inp => inp.disabled = false);
          }
          // Re-render to show "Response recorded"
          render();
        }
      });

      // Socket for realtime state changes
      const s = document.createElement('script');
      s.src = '/socket.io/socket.io.js';
      s.onload = () => {
        const socket = io();
        socket.on('stateChanged', async () => {
          await loadQuestions();
          if (state.status === 'ended') {
            window.location.href = '/thankyou.html';
          }
        });
        // No participant stats; nothing to do on statsUpdated
      };
      document.body.appendChild(s);

      loadQuestions();
    </script>
  </body>
  </html>


